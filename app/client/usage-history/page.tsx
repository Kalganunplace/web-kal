"use client"

import BottomSheet from "@/components/ui/bottom-sheet"
import { ChevronDownIcon, ChevronRightIcon } from "@/components/ui/icon"
import TopBanner from "@/components/ui/top-banner"
import { BodyMedium, BodySmall, CaptionLarge } from "@/components/ui/typography"
import { useUserBookings } from '@/hooks/queries/use-booking'
import { createClient } from '@/lib/auth/supabase'
import { type Booking } from '@/lib/booking-service'
import { paymentService } from '@/lib/payment-service'
import { useIsAuthenticated } from '@/stores/auth-store'
import { useQuery } from '@tanstack/react-query'
import { format } from 'date-fns'
import { ko } from 'date-fns/locale'
import { useRouter } from "next/navigation"
import { useState } from "react"

export default function UsageHistoryPage() {
  const router = useRouter()
  const { user, isAuthenticated, isLoading: authLoading } = useIsAuthenticated()

  const [selectedItem, setSelectedItem] = useState<Booking | null>(null)
  const [showLoginSheet, setShowLoginSheet] = useState(false)

  // React Query ÌõÖ ÏÇ¨Ïö©
  const { data: bookings = [], isLoading } = useUserBookings()

  // Î™®Îì† ÏòàÏïΩÏùò Í≤∞Ï†ú Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
  const { data: payments = new Map() } = useQuery({
    queryKey: ['payments', 'bookings', bookings.map(b => b.id)],
    queryFn: async () => {
      if (!user?.id || bookings.length === 0) return new Map()

      const paymentMap = new Map()
      await Promise.all(
        bookings.map(async (booking) => {
          const payment = await paymentService.getPaymentByBookingId(booking.id, user.id)
          if (payment) {
            paymentMap.set(booking.id, payment)
          }
        })
      )
      return paymentMap
    },
    enabled: !!user?.id && bookings.length > 0,
  })

  // Î™®Îì† ÏòàÏïΩÏùò Ïø†Ìè∞ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
  const { data: usedCoupons = new Map() } = useQuery({
    queryKey: ['used-coupons', 'bookings', bookings.map(b => b.id)],
    queryFn: async () => {
      if (!user?.id || bookings.length === 0) return new Map()

      try {
        const supabase = createClient()
        const couponMap = new Map()

        // ÏÇ¨Ïö©Îêú Ïø†Ìè∞ Ï°∞Ìöå (booking_idÎ°ú ÌïÑÌÑ∞ÎßÅ)
        const { data: userCoupons, error } = await supabase
          .from('user_coupons')
          .select(`
            *,
            coupon:coupons(*)
          `)
          .eq('user_id', user.id)
          .eq('is_used', true)
          .in('booking_id', bookings.map(b => b.id))

        if (error) {
          console.error('Ïø†Ìè∞ Ï°∞Ìöå Ïò§Î•ò (Î¨¥ÏãúÎê®):', error)
          return couponMap // Îπà Map Î∞òÌôò
        }

        if (userCoupons) {
          userCoupons.forEach(uc => {
            if (uc.booking_id) {
              couponMap.set(uc.booking_id, uc)
            }
          })
        }

        return couponMap
      } catch (error) {
        console.error('Ïø†Ìè∞ Î°úÎìú Ïã§Ìå® (Î¨¥ÏãúÎê®):', error)
        return new Map()
      }
    },
    enabled: !!user?.id && bookings.length > 0,
  })

  // ÌòÑÏû¨ ÏßÑÌñâ Ï§ëÏù∏ ÏÑúÎπÑÏä§ (ÏôÑÎ£å/Ï∑®ÏÜåÍ∞Ä ÏïÑÎãå Î™®Îì† ÏÉÅÌÉú)
  const currentService = bookings.find(b =>
    b.status !== 'completed' && b.status !== 'cancelled'
  )
  const hasCurrentService = !!currentService

  // ÏôÑÎ£åÎêú ÏÑúÎπÑÏä§
  const completedBookings = bookings.filter(b =>
    b.status === 'completed' || b.status === 'cancelled'
  )
  const hasHistory = completedBookings.length > 0

  // Ïó∞Í∞Ñ ÌÜµÍ≥Ñ Í≥ÑÏÇ∞
  const currentYear = new Date().getFullYear()
  const yearlyBookings = bookings.filter(b =>
    new Date(b.booking_date).getFullYear() === currentYear
  )
  const yearlyStats = {
    year: currentYear,
    sharpening_count: yearlyBookings.length,
    total_amount: yearlyBookings.reduce((sum, b) => sum + b.total_amount, 0).toLocaleString() + 'Ïõê'
  }

  // Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú
  const userStatus = isAuthenticated ? "logged_in" : "logged_out"

  // Îç∞Ïù¥ÌÑ∞ Î°úÎìú

  // ÏÉÅÌÉúÎ≥Ñ ÌëúÏãú Îß§Ìïë
  const getStatusDisplay = (status: string) => {
    const statusMap: Record<string, { text: string; icon: string; description: string }> = {
      'pending': {
        text: 'ÏòÅÏàòÏ¶ù',
        icon: '‚úèÔ∏è',
        description: 'ÏπºÍ∞àÏù¥ Ïã†Ï≤≠Ïù¥ Ï†ëÏàòÎêòÏóàÏñ¥Ïöî!\nÏù¥Ï†ú Í≤∞Ï†úÎ•º ÏßÑÌñâÌï¥ Ï£ºÏãúÎ©¥ Îê©ÎãàÎã§'
      },
      'payment_pending': {
        text: 'ÏòÅÏàòÏ¶ù',
        icon: 'üí≥',
        description: 'Í≤∞Ï†ú ÏßÑÌñâ Ï§ëÏûÖÎãàÎã§\nÍ≤∞Ï†úÌï¥Ï£ºÏãúÎ©¥ ÏòàÏïΩÏù¥ ÎßàÎ¨¥Î¶¨ Îê©ÎãàÎã§'
      },
      'confirmed': {
        text: 'ÏòÅÏàòÏ¶ù',
        icon: 'üìÖ',
        description: 'Î∞©Î¨∏ ÏòàÏïΩ ÌôïÏ†ï Ï§ëÏûÖÎãàÎã§\nÏû•Ïù∏Î∂ÑÍ≥º ÏùºÏ†ïÏùÑ Ï°∞Ïú® Ï§ëÏù¥ÏóêÏöî :)'
      },
      'ready_for_pickup': {
        text: 'ÏòÅÏàòÏ¶ù',
        icon: 'üì¶',
        description: 'ÏπºÏùÑ Ï§ÄÎπÑÌï¥Ï£ºÏÑ∏Ïöî!\nÏ†ÄÌù¨Í∞Ä Í≥ß ÌîΩÏóÖÌïòÎü¨ Í∞àÍ≤åÏöî'
      },
      'in_progress': {
        text: 'ÏòÅÏàòÏ¶ù',
        icon: 'üî®',
        description: 'Ïû•Ïù∏Ïù¥ ÏπºÏùÑ Ïó∞ÎßàÌïòÍ≥† ÏûàÏñ¥Ïöî\nÏó¥Ïã¨ÌûàÎèÑ Îã¨Íµ¨ÏãúÎäî Î™®ÏäµÏù¥ ÏûàÏñ¥Ïöî'
      },
      'shipping': {
        text: 'ÏòÅÏàòÏ¶ù',
        icon: 'üöö',
        description: 'ÏπºÏù¥ Î∞∞ÏÜ°Ï§ëÏûÖÎãàÎã§!\nÎÇ†Ïπ¥Î°≠Í≤å Îã§Îì¨Ïñ¥ÏßÑ ÏπºÏù¥ Îπ†Î•¥Í≤å Ïù¥Îèô Ï§ëÏù¥ÏóêÏöî :)'
      },
      'completed': {
        text: 'ÏòÅÏàòÏ¶ù',
        icon: '‚úÖ',
        description: 'ÏπºÍ∞àÏù¥ ÏôÑÎ£å!\nÎÇ†Ïù¥ Î¨¥ÎéåÏßàÎïå Î∞îÎ°ú Ï∞æÏïÑ Ï£ºÏÑ∏Ïöî!'
      },
      'cancelled': {
        text: 'ÏòÅÏàòÏ¶ù',
        icon: '‚ùå',
        description: 'ÏòàÏïΩÏù¥ Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§'
      }
    }
    return statusMap[status] || { text: 'ÏòÅÏàòÏ¶ù', icon: 'üî™', description: status }
  }

  // ÏòàÏïΩ Îç∞Ïù¥ÌÑ∞Î•º ÌûàÏä§ÌÜ†Î¶¨ ÏïÑÏù¥ÌÖúÏúºÎ°ú Î≥ÄÌôò
  const formatBookingDate = (booking: Booking) => {
    return format(new Date(booking.booking_date), 'MÏõî dÏùº', { locale: ko })
  }

  const formatBookingItems = (booking: Booking) => {
    if (!booking.booking_items || booking.booking_items.length === 0) {
      return `ÏπºÍ∞àÏù¥ ${booking.total_quantity}Í∞ú`
    }
    return booking.booking_items.map(item =>
      `${item.knife_type?.name || 'Ïπº'} ${item.quantity}Í∞ú`
    ).join(', ')
  }

  const handleItemClick = (booking: Booking) => {
    setSelectedItem(booking)
  }

  const handleCloseDetailView = () => {
    setSelectedItem(null)
  }

  const handleLoginClick = () => {
    setShowLoginSheet(false)
    router.push("/client/login")
  }

  const handleSignupClick = () => {
    setShowLoginSheet(false)
    router.push("/client/signup")
  }

  const handleShowLogin = () => {
    setShowLoginSheet(true)
  }

  const handleCloseLogin = () => {
    setShowLoginSheet(false)
  }

  // ÏòÅÏàòÏ¶ù ÏÉÅÏÑ∏ Î∑∞
  if (selectedItem) {
    const payment = payments.get(selectedItem.id)
    const usedCoupon = usedCoupons.get(selectedItem.id)

    // Ìï†Ïù∏ Î∞è ÏÑ∏Í∏à Í≥ÑÏÇ∞
    const discountAmount = usedCoupon?.discount_amount || 0
    const originalAmount = usedCoupon?.original_order_amount || selectedItem.total_amount
    const finalAmount = selectedItem.total_amount
    const taxAmount = Math.floor(finalAmount * 0.1) // 10% Î∂ÄÍ∞ÄÏÑ∏

    return (
      <>
        <TopBanner
          title="Ïù¥Ïö©ÎÇ¥Ïó≠"
          onBackClick={handleCloseDetailView}
        />

        <div className="flex flex-col items-center gap-5 px-5">
          {/* Date Header */}
          <div className="w-full mt-5">
            <div className="flex items-center">
              <BodyMedium color="#333333">{formatBookingDate(selectedItem)}</BodyMedium>
            </div>
          </div>

          {/* Receipt Card */}
          <div className="w-full bg-white rounded-[15px] shadow-[0px_5px_30px_0px_rgba(0,0,0,0.1)] py-[30px]">
            <div className="flex flex-col">
              {/* Receipt Header */}
              <div className="flex flex-col items-center gap-2 px-[30px] pb-[20px]">
                <div className="text-2xl">üßæ</div>
                <BodyMedium color="#333333">ÏòÅÏàòÏ¶ù</BodyMedium>
                <BodyMedium color="#E67E22" className="text-xl font-bold">
                  {selectedItem.total_amount.toLocaleString()}Ïõê
                </BodyMedium>
              </div>

              {/* Orange Divider */}
              <div className="w-full h-[2px] bg-[#E67E22] mb-[20px]" />

              {/* Order Details */}
              <div className="px-[30px] space-y-4">
                {/* Order Info */}
                <div className="space-y-2">
                  <div className="flex justify-between">
                    <CaptionLarge color="#767676">Ï£ºÎ¨∏Î≤àÌò∏</CaptionLarge>
                    <CaptionLarge color="#333333">{selectedItem.id.slice(0, 8).toUpperCase()}</CaptionLarge>
                  </div>
                  <div className="flex justify-between">
                    <CaptionLarge color="#767676">Ï£ºÎ¨∏ÏãúÍ∞Ñ</CaptionLarge>
                    <CaptionLarge color="#333333">{selectedItem.booking_time}</CaptionLarge>
                  </div>
                </div>

                {/* Order Type */}
                <div className="bg-[#FFF9F0] rounded-[10px] p-3">
                  <CaptionLarge color="#E67E22" className="font-bold">ÏπºÍ∞àÏù¥ ÏÑúÎπÑÏä§</CaptionLarge>
                </div>

                {/* Order Items */}
                <div className="space-y-2">
                  <CaptionLarge color="#E67E22" className="font-bold">ÏùºÎ∞ò Ï£ºÎ¨∏</CaptionLarge>
                  {selectedItem.booking_items?.map((item, index) => (
                    <div key={index} className="flex justify-between items-center">
                      <CaptionLarge color="#333333">
                        {item.knife_type?.name || 'Ïπº'} √ó {item.quantity}
                      </CaptionLarge>
                      <CaptionLarge color="#333333">{item.total_price.toLocaleString()}Ïõê</CaptionLarge>
                    </div>
                  )) || (
                    <div className="flex justify-between items-center">
                      <CaptionLarge color="#333333">ÏπºÍ∞àÏù¥ √ó {selectedItem.total_quantity}</CaptionLarge>
                      <CaptionLarge color="#333333">{selectedItem.total_amount.toLocaleString()}Ïõê</CaptionLarge>
                    </div>
                  )}
                </div>

                {/* White Divider */}
                <div className="w-full h-[1px] bg-[#F0F0F0]" />

                {/* Additional Info */}
                <div className="bg-[#F8F8F8] rounded-[10px] p-3">
                  <CaptionLarge color="#767676" className="font-bold mb-2">Í∏∞ÌÉÄ Ï†ïÎ≥¥</CaptionLarge>
                  <div className="space-y-1">
                    {/* Ìï†Ïù∏Ïù¥ ÏûàÎäî Í≤ΩÏö∞ÏóêÎßå ÌëúÏãú */}
                    {discountAmount > 0 && (
                      <>
                        <div className="flex justify-between">
                          <CaptionLarge color="#767676">Ìï†Ïù∏</CaptionLarge>
                          <CaptionLarge color="#E67E22">-{discountAmount.toLocaleString()}Ïõê</CaptionLarge>
                        </div>
                        {usedCoupon?.coupon && (
                          <div className="flex justify-between">
                            <CaptionLarge color="#767676">{usedCoupon.coupon.name}</CaptionLarge>
                            <CaptionLarge color="#333333"></CaptionLarge>
                          </div>
                        )}
                      </>
                    )}
                    <div className="flex justify-between">
                      <CaptionLarge color="#767676">Î∂ÄÍ∞ÄÏÑ∏</CaptionLarge>
                      <CaptionLarge color="#333333">{taxAmount.toLocaleString()}Ïõê</CaptionLarge>
                    </div>
                    <div className="flex justify-between">
                      <CaptionLarge color="#767676">Í≤∞Ï†ú ÏàòÎã®</CaptionLarge>
                      <CaptionLarge color="#333333">
                        {payment ? paymentService.getPaymentMethodText(payment.payment_method) : 'Î¨¥ÌÜµÏû•ÏûÖÍ∏à'}
                      </CaptionLarge>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Bottom Safe Area */}
        <div className="h-20" />
      </>
    )
  }

  // Î°úÍ∑∏Ïù∏ÌïòÏßÄ ÏïäÏùÄ ÏÉÅÌÉú
  if (userStatus === "logged_out") {
    return (
      <>
        {/* Background */}
        <div className="min-h-screen bg-gradient-to-b from-orange-500 to-orange-400">
          {/* Logo Section */}
          <div className="flex justify-center pt-16 pb-4">
            <div className="flex items-center gap-2">
              <div className="w-8 h-8 text-white text-2xl">üìç</div>
              <span className="text-white text-sm font-medium">ÎåÄÍµ¨</span>
            </div>
          </div>

          {/* Logo */}
          <div className="flex justify-center mb-6">
            <div className="text-white text-3xl font-bold">ÏπºÍ∞ÄÎäîÍ≥≥</div>
          </div>

          {/* Main Banner */}
          <div className="mx-5 mb-5 bg-white/10 backdrop-blur-sm rounded-[30px] p-5 h-[360px] relative overflow-hidden">
            <div className="absolute inset-0 bg-gradient-to-br from-white/20 to-transparent rounded-[30px]" />
            <div className="relative z-10 flex flex-col justify-end h-full">
              <div className="mb-6">
                <h2 className="text-white text-2xl font-bold mb-2 leading-tight">
                  ÎçîÏù¥ÏÉÅ ÏπºÎ°ú<br />
                  ÏúºÍπ®ÏßÄ ÎßàÏÑ∏Ïöî.<br />
                  Ïç∞Ïñ¥ÏïºÏ£†...
                </h2>
              </div>
              <button
                onClick={() => router.push("/client/knife-request")}
                className="bg-white text-orange-500 rounded-lg py-3 px-6 font-medium"
              >
                Ï≤´ ÏπºÍ∞àÏù¥ Ïã†Ï≤≠ÌïòÍ∏∞
              </button>
            </div>
          </div>

          {/* Quick Actions */}
          <div className="mx-5 mb-5 flex gap-5">
            <button
              onClick={() => router.push("/client/price-list")}
              className="flex-1 bg-white/10 backdrop-blur-sm rounded-lg p-4 flex items-center justify-between"
            >
              <span className="text-white font-medium">Í∞ÄÍ≤©Ìëú</span>
              <span className="text-white text-xl">üí∞</span>
            </button>
            <button
              onClick={() => router.push("/client/guide")}
              className="flex-1 bg-white/10 backdrop-blur-sm rounded-lg p-4 flex items-center justify-between"
            >
              <span className="text-white font-medium">Í∞ÄÏù¥Îìú</span>
              <span className="text-white text-xl">‚ÑπÔ∏è</span>
            </button>
          </div>

          {/* Promotional Cards */}
          <div className="mx-5 space-y-4 mb-20">
            <div className="bg-gradient-to-r from-orange-600 to-orange-500 rounded-[30px] p-6 text-white">
              <div className="text-xs mb-2 opacity-90">Ïã†Í∑úÍ≥†Í∞ù Ï†ÑÏö© 1+1 Ïù¥Î≤§Ìä∏</div>
              <div className="flex items-center gap-2 text-2xl font-bold">
                <span>ÌïòÎÇòÍ∞àÎ©¥</span>
                <span className="text-sm">+</span>
                <span className="text-yellow-300">ÌïòÎÇòÎ¨¥Î£å</span>
              </div>
            </div>
            <div className="bg-orange-100 rounded-[30px] p-6">
              <div className="flex items-center justify-between">
                <div>
                  <div className="text-orange-600 text-2xl font-bold mb-1">
                    Ïù¥Ï†ú ÏπºÍ∞àÏù¥ÎèÑ<br />Íµ¨ÎèÖÏúºÎ°ú!
                  </div>
                </div>
                <div className="text-4xl">üî™</div>
              </div>
            </div>
          </div>

          {/* Fixed Login Button */}
          <div className="fixed bottom-5 left-5 right-5">
            <button
              onClick={handleShowLogin}
              className="w-full bg-white text-orange-500 rounded-[30px] py-4 font-bold text-lg shadow-lg"
            >
              Î°úÍ∑∏Ïù∏ÌïòÍ≥† Ïù¥Ïö©ÎÇ¥Ïó≠ Î≥¥Í∏∞
            </button>
          </div>
        </div>

        {/* Login Bottom Sheet */}
        <BottomSheet
          isOpen={showLoginSheet}
          onClose={handleCloseLogin}
          className="max-h-[400px]"
        >
          <div className="flex flex-col gap-6 p-6">
            <div className="text-center">
              <div className="w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <span className="text-3xl">üõ°Ô∏è</span>
              </div>
              <h3 className="text-xl font-bold mb-2">Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï¥Ïöî</h3>
              <p className="text-gray-600 text-sm">
                Í∞ÑÌé∏ÌïòÍ≤å Î°úÍ∑∏Ïù∏ÌïòÍ≥†<br />
                ÏπºÍ∞ÄÎäîÍ≥≥Ïùò Îã§ÏñëÌïú ÏÑúÎπÑÏä§Î•º Ïù¥Ïö©Ìï¥Î≥¥ÏÑ∏Ïöî!
              </p>
            </div>
            <div className="space-y-3">
              <button
                onClick={handleLoginClick}
                className="w-full bg-orange-500 text-white rounded-lg py-4 font-medium"
              >
                Î°úÍ∑∏Ïù∏ ¬∑ ÌöåÏõêÍ∞ÄÏûÖ
              </button>
              <button
                onClick={handleCloseLogin}
                className="w-full bg-gray-100 text-gray-600 rounded-lg py-4 font-medium"
              >
                ÎÇòÏ§ëÏóê Í∞ÄÏûÖ
              </button>
            </div>
          </div>
        </BottomSheet>
      </>
    )
  }

  // Î°úÎî© ÏÉÅÌÉú (Ïù∏Ï¶ù Î°úÎî© ÎòêÎäî Îç∞Ïù¥ÌÑ∞ Î°úÎî©)
  if (authLoading || isLoading) {
    return (
      <>
        <TopBanner
          title="Ïù¥Ïö©ÎÇ¥Ïó≠"
          onBackClick={() => router.back()}
        />
        <div className="flex flex-col items-center justify-center h-96">
          <div className="w-12 h-12 animate-spin rounded-full border-4 border-orange-200 border-t-orange-500 mb-4"></div>
          <BodyMedium color="#767676">Î°úÎî© Ï§ë...</BodyMedium>
        </div>
      </>
    )
  }

  return (
    <>
      {/* Top Banner */}
      <TopBanner
        title="Ïù¥Ïö©ÎÇ¥Ïó≠"
        onBackClick={() => router.back()}
      />

      <div className="flex flex-col items-center gap-5 px-0">
        {/* Current Service Section */}
        {hasCurrentService && currentService && (
          <div className="w-full px-5">
            <div className="flex justify-between items-center gap-5 mb-5">
              <BodyMedium color="#333333">ÌòÑÏû¨ ÏßÑÌñâ Ï§ëÏù∏ ÏÑúÎπÑÏä§</BodyMedium>
            </div>
            <div className="bg-white rounded-[30px] shadow-[0px_6px_12px_-6px_rgba(24,39,75,0.12),_0px_8px_24px_-4px_rgba(24,39,75,0.08)] p-6 flex flex-col items-center gap-3">
              <div className="text-5xl">{getStatusDisplay(currentService.status).icon}</div>
              <div className="text-center">
                <BodyMedium color="#333333" className="font-bold whitespace-pre-line">
                  {getStatusDisplay(currentService.status).description}
                </BodyMedium>
              </div>
            </div>
          </div>
        )}

        {/* No Current Service */}
        {!hasCurrentService && (
          <div className="w-full px-5">
            <div className="flex justify-between items-center gap-5 mb-5">
              <BodyMedium color="#333333">ÌòÑÏû¨ ÏßÑÌñâ Ï§ëÏù∏ ÏÑúÎπÑÏä§</BodyMedium>
            </div>
            <div className="bg-white rounded-[30px] shadow-[0px_6px_12px_-6px_rgba(24,39,75,0.12),_0px_8px_24px_-4px_rgba(24,39,75,0.08)] p-6 flex flex-col items-center gap-3">
              <div className="text-5xl">‚úèÔ∏è</div>
              <div className="text-center">
                <BodyMedium color="#333333" className="font-bold whitespace-pre-line">
                  ÌòÑÏû¨ ÏßÑÌñâ Ï§ëÏù∏ ÏÑúÎπÑÏä§Í∞Ä ÏóÜÏäµÎãàÎã§{'\n'}
                  ÏπºÍ∞àÏù¥, ÏßÄÍ∏à Î∞îÎ°ú Ïã†Ï≤≠Ìï¥Î≥¥ÏÑ∏Ïöî!
                </BodyMedium>
              </div>
              <button
                onClick={() => router.push('/client/knife-request')}
                className="mt-2 bg-[#E67E22] text-white px-6 py-2.5 rounded-lg font-medium text-sm"
              >
                ÏπºÍ∞àÏù¥ Ïã†Ï≤≠ÌïòÍ∏∞
              </button>
            </div>
          </div>
        )}

        {/* Year Selection & Stats */}
        <div className="w-full  px-5 space-y-5">
          {/* Year Selector */}
          <div className="flex justify-between items-center">
            <div className="flex items-center gap-2">
              <BodyMedium color="#333333">{yearlyStats.year}</BodyMedium>
              <ChevronDownIcon size={20} className="text-[#767676]" />
            </div>
          </div>

          {/* Stats */}
          <div className="flex justify-between items-center">
            <div>
              <BodySmall color="#767676">Ïò¨Ìï¥ Ïó∞Îßà ÌöüÏàò</BodySmall>
              <BodyMedium color="#333333">{yearlyStats.sharpening_count}Ìöå</BodyMedium>
            </div>
            <div className="text-right">
              <BodySmall color="#767676">Ï¥ù Ïù¥Ïö© Í∏àÏï°</BodySmall>
              <BodyMedium color="#E67E22">{yearlyStats.total_amount}</BodyMedium>
            </div>
          </div>
        </div>

        {/* History Items or Empty State */}
        {bookings.length > 0 ? (
          <div className="w-full  px-5 space-y-5">
            {bookings.map((booking, index) => (
              <div key={booking.id} className="space-y-3">
                {/* Date Header */}
                <div className="flex items-center">
                  <BodyMedium color="#333333">{formatBookingDate(booking)}</BodyMedium>
                </div>

                {/* History Item */}
                <div
                  className="bg-white p-4 flex items-center gap-4 cursor-pointer"
                  onClick={() => handleItemClick(booking)}
                >
                  <div className="text-xl">{getStatusDisplay(booking.status).icon}</div>
                  <div className="flex-1">
                    <div className="flex justify-between items-start mb-1">
                      <BodyMedium color="#333333">{booking.total_amount.toLocaleString()}Ïõê</BodyMedium>
                      <ChevronRightIcon size={20} className="text-[#767676]" />
                    </div>
                    <BodySmall color="#767676">{formatBookingItems(booking)}</BodySmall>
                  </div>
                </div>

                {/* Separator */}
                {index < bookings.length - 1 && (
                  <div className="w-full h-px bg-[#F0F0F0]" />
                )}
              </div>
            ))}
          </div>
        ) : (
          /* Empty History State */
          <div className="w-full px-5">
            <div className="bg-white rounded-[30px] shadow-[0px_6px_12px_-6px_rgba(24,39,75,0.12),_0px_8px_24px_-4px_rgba(24,39,75,0.08)] p-6 flex flex-col items-center gap-3">
              <div className="text-5xl">üìã</div>
              <div className="text-center">
                <BodyMedium color="#333333" className="font-bold whitespace-pre-line">
                  Ïù¥Ïö© ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§{'\n'}
                  ÏπºÍ∞àÏù¥, ÏßÄÍ∏à Î∞îÎ°ú Ïã†Ï≤≠Ìï¥Î≥¥ÏÑ∏Ïöî!
                </BodyMedium>
              </div>
              <button
                onClick={() => router.push("/client/knife-request")}
                className="mt-2 bg-[#E67E22] text-white px-6 py-2.5 rounded-lg font-medium text-sm"
              >
                ÏπºÍ∞àÏù¥ Ïã†Ï≤≠ÌïòÍ∏∞
              </button>
            </div>
          </div>
        )}
      </div>

      {/* Bottom Safe Area */}
      <div className="h-20" />
    </>
  )
}
